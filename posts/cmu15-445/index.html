<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CMU15-445 - Jimmy's Blog</title><meta name=Description content="embrace the challenge, make the effort, take the credit."><meta property="og:title" content="CMU15-445"><meta property="og:description" content="前言 雖然project的部分有點窒礙難行，不過既然都聽課了還是把筆記做好吧！ CS CMU 15-445/645, Fall 2019/2021 related resources gradescope newtest_2021 my repo reference Relational Model logical layer separate from physical layer tuple/record/row mean same thing table/relation mean same thing value in tuple should"><meta property="og:type" content="article"><meta property="og:url" content="https://jimmyweng006.github.io/posts/cmu15-445/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-24T12:04:27+08:00"><meta property="article:modified_time" content="2022-06-24T12:04:27+08:00"><meta property="og:site_name" content="Jimmy's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="CMU15-445"><meta name=twitter:description content="前言 雖然project的部分有點窒礙難行，不過既然都聽課了還是把筆記做好吧！ CS CMU 15-445/645, Fall 2019/2021 related resources gradescope newtest_2021 my repo reference Relational Model logical layer separate from physical layer tuple/record/row mean same thing table/relation mean same thing value in tuple should"><meta name=application-name content="Jimmy's Blog"><meta name=apple-mobile-web-app-title content="Jimmy's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jimmyweng006.github.io/posts/cmu15-445/><link rel=prev href=https://jimmyweng006.github.io/posts/hugo-config/><link rel=next href=https://jimmyweng006.github.io/posts/online-judge/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CMU15-445","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jimmyweng006.github.io\/posts\/cmu15-445\/"},"genre":"posts","wordcount":3841,"url":"https:\/\/jimmyweng006.github.io\/posts\/cmu15-445\/","datePublished":"2022-06-24T12:04:27+08:00","dateModified":"2022-06-24T12:04:27+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Jimmy_kiet"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Jimmy's Blog">Jimmy's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>posts </a><a class=menu-item href=/tags/>tags </a><a class=menu-item href=/categories/>categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Jimmy's Blog">Jimmy's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>posts</a><a class=menu-item href=/tags/ title>tags</a><a class=menu-item href=/categories/ title>categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CMU15-445</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Jimmy_kiet</a></span>&nbsp;<span class=post-category>included in <a href=/categories/database/><i class="far fa-folder fa-fw" aria-hidden=true></i>Database</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-06-24>2022-06-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3841 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#relational-model>Relational Model</a></li><li><a href=#advanced-sql>Advanced SQL</a><ul><li><a href=#aggregate>Aggregate</a></li><li><a href=#group-by>Group By</a></li><li><a href=#having>Having</a></li><li><a href=#like>Like</a></li><li><a href=#output-redirection>Output Redirection</a></li><li><a href=#output-control>Output Control</a></li><li><a href=#nested-queries>Nested Queries</a></li><li><a href=#window-funtion>Window Funtion</a></li><li><a href=#common-table-expression>Common Table Expression</a></li></ul></li><li><a href=#homework-12019>HomeWork 1(2019)</a></li><li><a href=#database-storage-i>Database Storage I</a><ul><li><a href=#manage-pages>Manage Pages</a></li><li><a href=#data-layout>Data Layout</a></li><li><a href=#tuple-layout>Tuple Layout</a></li></ul></li><li><a href=#database-storage-ii>Database Storage II</a><ul><li><a href=#tuple-storage>Tuple Storage</a></li><li><a href=#data-type>Data Type</a></li><li><a href=#system-catalogs>System Catalogs</a></li><li><a href=#database-workloads>Database Workloads</a></li><li><a href=#data-storage-model>Data Storage Model</a></li></ul></li><li><a href=#projects-setup>Projects Setup</a></li><li><a href=#projects-02021>Projects 0(2021)</a><ul><li><a href=#test>test</a></li><li><a href=#format>format</a></li></ul></li><li><a href=#buffer-pools>Buffer Pools</a><ul><li><a href=#buffer-pool-optimization>Buffer Pool Optimization</a></li><li><a href=#buffer-pool-replacement-policies>Buffer Pool Replacement Policies</a></li></ul></li><li><a href=#projects-12021>Projects 1(2021)</a></li><li><a href=#hash-tables>Hash Tables</a></li><li><a href=#tree-indexes-i>Tree Indexes I</a></li><li><a href=#tree-indexes-ii>Tree Indexes II</a><ul><li><a href=#implicit-indexes>Implicit Indexes</a></li><li><a href=#partial-indexes>Partial Indexes</a></li><li><a href=#inverted-indexes>Inverted Indexes</a></li></ul></li><li><a href=#multi-threaded-index-concurrency-control>Multi-Threaded Index Concurrency Control</a><ul><li><a href=#hash-table-latching-no-deadlock-because-requiring-latchs-happened-in-same-direction>HASH TABLE LATCHING: no deadlock, because requiring latchs happened in same direction</a></li><li><a href=#btree-concurrency-control>B+TREE CONCURRENCY CONTROL</a></li><li><a href=#leaf-node-scanrange-query>LEAF NODE SCAN(range query)</a></li></ul></li><li><a href=#sorting--aggregations>Sorting & Aggregations</a><ul><li><a href=#query-processing>Query Processing</a></li><li><a href=#double-buffering-optimization>DOUBLE BUFFERING OPTIMIZATION</a></li><li><a href=#general-external-merge-sort>General External Merge Sort</a></li><li><a href=#using-btrees-for-sorting>USING B+TREES FOR SORTING</a></li><li><a href=#aggregation>Aggregation</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=前言>前言</h2><p>雖然project的部分有點窒礙難行，不過既然都聽課了還是把筆記做好吧！</p><blockquote><p><a href=https://15445.courses.cs.cmu.edu/fall2019/ target=_blank rel="noopener noreffer">CS CMU 15-445/645, Fall 2019/2021</a></p></blockquote><blockquote><p><a href=https://conanhujinming.github.io/comments-for-awesome-courses/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU15445%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ target=_blank rel="noopener noreffer">related resources</a></p></blockquote><blockquote><p><a href=https://www.gradescope.com/courses/305244 target=_blank rel="noopener noreffer">gradescope newtest_2021</a></p></blockquote><blockquote><p><a href=https://github.com/Jimmyweng006/bustub-private target=_blank rel="noopener noreffer">my repo</a></p></blockquote><blockquote><p><a href=https://zhenghe.gitbook.io/open-courses/cmu-15-445-645-database-systems/relational-data-model target=_blank rel="noopener noreffer">reference</a></p></blockquote><h2 id=relational-model>Relational Model</h2><blockquote><p>logical layer separate from physical layer</p></blockquote><p>tuple/record/row mean same thing
table/relation mean same thing
value in tuple should be atomic</p><ul><li>Primary key：identify a specific tuple in current relation(table)</li><li>Foreign key：identify a specific tuple in another relation(table)</li></ul><hr><ul><li>Relational Algebra：Each operator takes one or more relations as its inputs and outputs a new relation.</li><li>join：more flexible intersection</li></ul><hr><h2 id=advanced-sql>Advanced SQL</h2><h3 id=aggregate>Aggregate</h3><ul><li>Aggregate functions can only be used in the SELECT output list</li><li>Output of other columns outside of an aggregate is undefined. -> aggregate function only output one value</li></ul><h3 id=group-by>Group By</h3><ul><li>Aggregates records by group</li><li>if output clause have one aggregate function, then other non-aggregate attribute should in Group By clause</li></ul><h3 id=having>Having</h3><ul><li>you can not use aggregation resulit in where clause because you don&rsquo;t have that result yet</li></ul><h3 id=like>Like</h3><ul><li>%：match for substring</li><li>_：match for character</li></ul><h3 id=output-redirection>Output Redirection</h3><ul><li>store output of previous query into new/existing table, schema should be match</li></ul><h3 id=output-control>Output Control</h3><ul><li>order by</li><li>limit</li></ul><h3 id=nested-queries>Nested Queries</h3><ul><li>only inner query can reference information in outer query</li></ul><h3 id=window-funtion>Window Funtion</h3><ul><li>aggregation(row_number) + group by(over)</li><li>in last example, maybe OVER() remain the same, and changeing RANK() to ROW_NUMBER() will get same result (?</li></ul><h3 id=common-table-expression>Common Table Expression</h3><ul><li>WITH statement is much more clear than nested query IMO.</li><li>WITH RECURSIVE：WTF</li></ul><h2 id=homework-12019>HomeWork 1(2019)</h2><p>Q4也太折磨&mldr;不過看來integer也能用Strign operation的like
好吧應該就是一點數學的trick&mldr;
2010s|2789741 好像錯了？ 全部總合也沒那麼多啊&mldr;</p><h2 id=database-storage-i>Database Storage I</h2><ul><li>Architecture</li></ul><pre tabindex=0><code>bottom to top(lower level to higher level)：

disk manager (database itself)
file system (OS provide)
</code></pre><ul><li>Storage Manager：organizes the files as a collection of pages<ol><li>represent data on disk</li><li>move data between disk and memory</li></ol></li><li>DataBase Pages：A page is a fixed-size block of data</li></ul><hr><h3 id=manage-pages>Manage Pages</h3><ol><li>Heap File：an unordered collection of pages<ul><li>Linked List：suck</li><li>Page Directory：</li></ul></li><li>Sequential/Sorted File：</li><li>Hashing File：</li></ol><h3 id=data-layout>Data Layout</h3><blockquote><p>Page：Header + Data</p></blockquote><ol><li>Tuple-oriented<ul><li>SLOTTED PAGES：slotted array(grow top to bottom) + fixed/variable length tuple of same table(grow bottom to top)</li><li>tuple is assigned a unique record identifier(page_id + offset/slot)</li></ul></li><li>log-oriented：read operation will be slow(recreate tuple), need index(jump to locations in the log)</li></ol><h3 id=tuple-layout>Tuple Layout</h3><ul><li>Denormalize：Store data from different tables into same page</li></ul><h2 id=database-storage-ii>Database Storage II</h2><h3 id=tuple-storage>Tuple Storage</h3><ul><li>DBMS interpret bytes into tables attribute and its value</li></ul><hr><h3 id=data-type>Data Type</h3><ul><li>FLOAT, REAL/DOUBLE：fast but not precise</li><li>NUMERIC, DECIMAL：slow but precise, use meta-data to get arbitrary precision</li></ul><hr><ul><li>Large Values：each tuple size should not greater than page size<ol><li>overflow/TOAST page：has protection</li><li>BLOB data type：DBMS can&rsquo;t midify the content of this file, but others can -> no protection</li></ol></li></ul><h3 id=system-catalogs>System Catalogs</h3><ul><li>meta-data about database</li><li>store catalogs as table</li></ul><h3 id=database-workloads>Database Workloads</h3><ul><li>OLTP(On-Line Transaction Processing)：query access only small portions of database(Write operations)</li><li>OLAP(On-Line Analytical Processing)：query access large portions of database(Read operations)</li></ul><h3 id=data-storage-model>Data Storage Model</h3><ul><li>N-ary Storage Model (NSM, row)<ol><li>store single tuple&rsquo;s attributes in a page</li><li>good for OLTP：queries that access small number of entire tuples</li><li>not good for OLAP：some attribues that bring from disk to memory become useless in query execution</li></ol></li><li>Decomposition Storage Model (DSM, column)<ol><li>store same attribute value of all tuples in a page</li><li>problems：how to track each tuple&rsquo;s attribute？<ol><li>Fixed-length Offsets：offsets</li><li>Embedded Tuple Ids：use tuple identifier for each attribute</li></ol></li></ol></li></ul><h2 id=projects-setup>Projects Setup</h2><p><a href=https://zhuanlan.zhihu.com/p/344374108 target=_blank rel="noopener noreffer">照著做沒煩惱</a>，repo的部分參考官方的做法。</p><p>origin docker engine content, 這個應該不用動？</p><pre tabindex=0><code class="language-json=" data-lang="json=">{
  &#34;features&#34;: {
    &#34;buildkit&#34;: true
  },
  &#34;builder&#34;: {
    &#34;gc&#34;: {
      &#34;enabled&#34;: true,
      &#34;defaultKeepStorage&#34;: &#34;20GB&#34;
    }
  },
  &#34;experimental&#34;: false
}
</code></pre><blockquote><p>在bustub文件中执行这一条命令</p></blockquote><p>應該是要在docker裡的bustub操作</p><blockquote><p>1.3 配置本地目录挂载</p></blockquote><p>太方便啦</p><p><code>docker container run -it -v /Users/jimmy/documents/CMU-DBMS/bustub-private:/bustub --name=bustub_env bustub /bin/bash</code></p><blockquote><p>重新執行</p></blockquote><ol><li>docker start 8dbdbd03dfed</li><li>docker exec -it 8dbdbd03dfed /bin/bash</li></ol><h2 id=projects-02021>Projects 0(2021)</h2><p><a href=https://localcoder.org/problem-with-protected-fields-in-base-class-in-c target=_blank rel="noopener noreffer">被繼承的東西到底要怎麼拿出來搞死&mldr;</a></p><p>throw exception請參照code base的方法&mldr;</p><h3 id=test>test</h3><pre tabindex=0><code>$ mkdir build
$ cd build
$ make starter_test
$ ./test/starter_test
</code></pre><h3 id=format>format</h3><pre tabindex=0><code>$ make format
$ make check-lint
$ make check-clang-tidy
</code></pre><p>zip project0-submission.zip src/include/primer/p0_starter.h</p><p>local run: make check-clang-tidy</p><p>encounter following: WTF ?</p><p>Checking: /bustub/src/buffer/lru_replacer.cppppr_instance.cppll.ccc
error: the clang compiler does not support &lsquo;-march=native&rsquo; [clang-diagnostic-error]</p><h2 id=buffer-pools>Buffer Pools</h2><ol><li>Spatial Control：often used paged be put together on disk</li><li>Temporal Control：minimize times to read pages from disk</li></ol><hr><ul><li>Buffer Pool = Memory Region = array of fixed size frame</li><li>Page Table：record the memory location of each page(currently in memory)、Dirty Flag、Pin/Reference Counter</li><li>Locks vs. Latches<ol><li>Lock：High level outside of database, need roll back changes</li><li>Latch：Low level inside of database(critical sections), does not need roll back changes</li></ol></li><li>Page Directory vs. Page Table<ol><li>Page Directory：find page location in datablase files by page id, need to be recorded on disk</li><li>Page Table：mapping between page id and location in buffer pool, does not need to be recorded on disk</li></ol></li></ul><h3 id=buffer-pool-optimization>Buffer Pool Optimization</h3><ul><li>Multiple Buffer Pool<ul><li>can use different policies for Buffer Pools</li></ul></li><li>Prefetching<ul><li>sequential：OS can do too</li><li>index：DBMS know index page meaning, so can fecth the exact pages that query wants</li></ul></li><li>Scan Sharing<ul><li>similar queries share same cursor</li></ul></li><li>Buffer Pool Bypass<ul><li>allocate other memory for sequential scan query in order not to pollute Buffer Pool</li></ul></li><li>OS Page Cache<ul><li>OS have same page copy on file system cache</li></ul></li></ul><h3 id=buffer-pool-replacement-policies>Buffer Pool Replacement Policies</h3><ol><li>LRU</li><li>clock(approximate LRU)</li></ol><ul><li>both have sequential flooding problem(Least Recently Used page might be most needed page)</li></ul><ol><li>LRU-K</li><li>Localization</li><li>Priority Hints</li><li>Dirty Pages vs. Non-Dirty Pages<ol><li>non-dirty page：fast. one I/O(read needed page from disk), may be needed in future</li><li>dirty page：slow. two I/O(write dirty page back to disk && read needed page from disk), often used with BACKGROUND WRITING</li></ol></li></ol><h2 id=projects-12021>Projects 1(2021)</h2><p><a href=https://www.bogotobogo.com/cplusplus/multithreaded4_cplusplus11B.php target=_blank rel="noopener noreffer">C++ mutithreading</a>
<a href=https://www.quora.com/How-does-a-C++-program-run target=_blank rel="noopener noreffer">How C++ code run</a></p><ul><li>LRUReplacer is used to store unpinned frames</li><li>Pin：this frame can&rsquo;t become victim</li><li>pin_count of a page becomes 0 = no threads access this page</li><li>page will be pinned when NewPage() invoke</li><li>FetchPgImp(pin) vs. UnpinPgImp</li><li>NewPgImp vs. DeletePgImp</li><li>page_table contain pin/unpinned pages! -> Delete operation will search unpinned page in page_table!</li></ul><hr><ul><li>domain knowledge</li></ul><pre tabindex=0><code>觀念沒有釐清，花太多時間在正確性不足的code上debug...
pages_ = buffer pools
page_table_ = {page_id, frame_id}
use frame_id to find page in pages_
free_list = unused frames
frame will be in {page_table_(buffer pools/pages_), free_list_, replacer_}, one of them
</code></pre><ul><li>task #1</li></ul><pre tabindex=0><code>根據data locality，剛被訪問(pin/unpin)的page很可能再次被訪問，所以放到replacer最後面(最新)。
而每次要victime page時從最前面(最老)開始，這樣就能達成最小化disk訪問次數的目標。

Unpin(frame_id_t) : This method should be called when the pin_count of a page becomes 0.
特別重要，但在lru裡面只管移除frame，外部使用者須自己注意call Unpin的時候page的pin_count &lt;= 0。
</code></pre><ul><li>task #2</li></ul><pre tabindex=0><code>FetchPgImp：根據page_id從bpm拿到Page。
如果在buffer pool(pages_)裡，pin完後直接return page。
不在就看有沒有free frame(從list or lru拿)，記得個別處理remove frame，
從page_table內把remove frame對應的victim page_id拿掉。
處理dirty，更新這個新page的metadata，寫到page_table_。

NewPgImp：為了AllocatePage的page_id，在buffer pool上清出一個空間。
如果buffer pools裡的page都為pinned-&gt;沒有空間了，return nullptr；
至少一個page不為pinned，這個page有可能屬於free_list_或是replacer_，需個別處理remove。
處理dirty，更新這個新page的metadata，寫到page_table_。

UnpinPgImp：將pages_上page_id對應的page，pin_count--。
處理dirty，更新這個新page的metadata，放回replacer_。

DeletePgImp：初始化(還回free_list_)buffer pool上 given page_id 的空間。
如果page_id不存在pages_，任務達成return true。
pin_count &gt; 0，有thread在用無法初始化，return false。
處理dirty，更新這個新page的metadata，從page_table_移除，放回free_list_。

FlushPgImp：
</code></pre><ul><li>task #3</li></ul><pre tabindex=0><code></code></pre><ul><li>todo 從76score branch，把邏輯對一對，cout拔掉，測試過了就交&mldr;</li><li>回來把code改寫完成了，結果跑出autograder failed to execute correctly是哪招&mldr;明明style也檢查過了</li></ul><h2 id=hash-tables>Hash Tables</h2><ul><li>Hash Table(Static)：</li></ul><ol><li>Hash Funciton：map keys(large space) to array index(small space), return a integer representaion of the given key<ul><li>trade-off：fast v.s collision rate。</li></ul></li><li>Hash Scheme：handle collision after hashing。<ul><li>trade-off：allocate large array v.s non efficient insert/find operations</li></ul><ol><li>linear probing：find empty/desired slot if hash idx slot is full/not desired</li></ol></li><li>situation：use in join</li></ol><hr><ul><li>Dynamic Hash Tables</li></ul><ol><li>Chained Hashing：each key maps to a linked-list<ul><li>easy to implement, worst case operation will become O(n)</li></ul></li><li>Extendible Hashing<ul><li>resize and rehash in the same time</li><li>problem：global latch</li></ul></li><li>Linear Hashing</li></ol><hr><ul><li>conclusion：good for database as internal data structure other than table index case(need ordering, so b+ tree is better)</li></ul><h2 id=tree-indexes-i>Tree Indexes I</h2><ul><li>table index：a replica of table, should be sync with table</li></ul><hr><ul><li>B means balance</li><li>B tree：key存在所有node(inner, leaf)裡 -> no duplicate keys</li><li>B+ tree：key存在leaf node裡 -> duplicate keys<ul><li>M keys in one node -> M + 1 children(# of intervals caused by M keys)</li><li>Every node other than the root, is at least half-full -> M/2-1 ≤ #keys ≤ M-1</li><li>node：meta-data、arrays of key-value pairs</li><li>key：table index column, value：tuple data or tuple data pointer</li><li>insert：keep # keys in one node satisfy property, otherwise do split operation</li><li>delete：keep # keys in one node satisfy property, otherwise do merge operation</li></ul></li></ul><hr><ul><li>index types：<ol><li>Clustered Indexes：<ol><li>each table has one Clustered Indexes</li><li>tuple is sorted(by primary key)</li></ol></li><li>Compound Index：use more than one attribute to build index</li></ol></li></ul><hr><ul><li>Optimizations</li></ul><ol><li>Prefix Compression：store keys same prefix + keys different suffix</li><li>Suffix Truncation：use minimum prefix to route to correct index</li><li>Bulk Insert：sort keys and bottom up build index</li><li>Pointer Swizzling：node stores page_id as reference to other nodes(need to go to buffer pool to get page pointer) -> stores page corresponding page pointer(valid)</li></ol><h2 id=tree-indexes-ii>Tree Indexes II</h2><ul><li>handle duplicate keys in b+ tree：Append Record Id</li></ul><hr><ul><li>no index or can&rsquo;t find index to use -> sequential scan</li><li>database will create index on primary key, otherwise we have no choice but sequential scan</li></ul><hr><h3 id=implicit-indexes>Implicit Indexes</h3><ul><li>Primary Keys</li><li>Unique Constraints</li><li>Foreign Keys(the attribute be referenced to should be unique)</li></ul><h3 id=partial-indexes>Partial Indexes</h3><ul><li>create index on subset of table</li></ul><pre tabindex=0><code class="language-sql=" data-lang="sql=">CREATE INDEX idx_foo
          ON foo (a, b)
       WHERE c = &#39;WuTang&#39;;
</code></pre><hr><ul><li>radix tree = compact trie</li></ul><hr><h3 id=inverted-indexes>Inverted Indexes</h3><ul><li>b+ tree index is good at point/range query</li><li>not good at keyword search -> full-text search index/inverted index</li></ul><h2 id=multi-threaded-index-concurrency-control>Multi-Threaded Index Concurrency Control</h2><ul><li>Concurrency control</li></ul><ol><li>Logical Correctness：</li><li>Physical Correctness：</li></ol><hr><ul><li>Latch Modes:</li></ul><ol><li>Read Mode: multiple threads in the same time</li><li>Write Mode: one thread in the same time</li></ol><hr><h3 id=hash-table-latching-no-deadlock-because-requiring-latchs-happened-in-same-direction>HASH TABLE LATCHING: no deadlock, because requiring latchs happened in same direction</h3><ol><li>Page Latches</li><li>Slot Latches</li></ol><hr><h3 id=btree-concurrency-control>B+TREE CONCURRENCY CONTROL</h3><ol><li>Latch Crabbing/Coupling<ol><li>acquire parent latch</li><li>acquire child latch</li><li>if child is safe, release parent latch</li></ol><ul><li>release the latch on node which has more children first(top to bottom)</li><li>all modifications start from taking write latch on root node -> bottle neck, so change to take read latch instead</li></ul></li><li>Better Latching Algorithm<ul><li>get read latch all the way down to leaf node(write latch), and check leaf node is safe or not</li><li>if not safe, do Latch Crabbing/Coupling</li></ul></li></ol><h3 id=leaf-node-scanrange-query>LEAF NODE SCAN(range query)</h3><ul><li>might have deadlock, so abort myself when desired latch can&rsquo;t acquire</li><li>Delayed Parent Updates(lazy update, apply for insert operation): Update parent node the next time that a thread takes a write latch on it.</li></ul><h2 id=sorting--aggregations>Sorting & Aggregations</h2><h3 id=query-processing>Query Processing</h3><ul><li>Data flows from leaves nodes to root node(query result)</li></ul><h3 id=double-buffering-optimization>DOUBLE BUFFERING OPTIMIZATION</h3><ul><li>Don&rsquo;t waste time on wating I/O request, so asynchronously fetch next runs while CPU processing the current runs</li></ul><h3 id=general-external-merge-sort>General External Merge Sort</h3><p>聽完影片後，再對照reference的筆記看一次就清楚多了&mldr;</p><ul><li>Sorting Phase: pages分成多個chunks，chunk可以完整放進memory，在memory裡排序好再放回disk。</li><li>Merge Phase: 從小runs到大runs</li><li>pass0:<ul><li>B buffer pages</li><li>ceiling(n / b)個大小為 B 的sorted runs</li></ul></li><li>pass1,2,3&mldr;: 合併B-1個runs</li><li>Complexity:<ul><li>number of passes: 1 + ceiling(lg(b-1)ceing(N/B))</li><li>cost per pass: 2N</li><li>total cost: number of passes * cost per pass</li></ul></li></ul><h3 id=using-btrees-for-sorting>USING B+TREES FOR SORTING</h3><ul><li>Clustered B+ Tree: order of key in b+ tree is equal to order of actual location of tuples</li><li>B+Tree index on the sort attribute(s)</li><li>use B+ tree only when there is Clustered B+ Tree case</li></ul><h3 id=aggregation>Aggregation</h3><ol><li>by Sort</li><li>by Hash<ol><li>Partition Phase: 根據hash的結果把tuple放到partition裡</li><li>Rehash Phase: 利用temp hash table計算aggregation的結果</li></ol></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-06-24</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://jimmyweng006.github.io/posts/cmu15-445/ data-title=CMU15-445><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://jimmyweng006.github.io/posts/cmu15-445/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://jimmyweng006.github.io/posts/cmu15-445/ data-title=CMU15-445><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://jimmyweng006.github.io/posts/cmu15-445/ data-title=CMU15-445><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://jimmyweng006.github.io/posts/cmu15-445/ data-title=CMU15-445><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/hugo-config/ class=prev rel=prev title="Hugo Config"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hugo Config</a>
<a href=/posts/online-judge/ class=next rel=next title=Online-Judge>Online-Judge<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Jimmy_kiet</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>