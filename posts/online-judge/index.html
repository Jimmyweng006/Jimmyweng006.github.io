<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Online-Judge - Jimmy's Blog</title><meta name=Description content="embrace the challenge, make the effort, take the credit."><meta property="og:title" content="Online-Judge">
<meta property="og:description" content="Online-Judge-Project 前言 紀錄一下學習強者的project過程，目前完成了前端以外的部分。 先把預計要做的事情寫下來，也算是給自己一個動力完成吧！ 把project"><meta property="og:type" content="article"><meta property="og:url" content="https://jimmyweng006.github.io/posts/online-judge/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-25T18:41:08+08:00"><meta property="article:modified_time" content="2022-06-25T18:41:08+08:00"><meta property="og:site_name" content="Jimmy's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Online-Judge"><meta name=twitter:description content="Online-Judge-Project 前言 紀錄一下學習強者的project過程，目前完成了前端以外的部分。 先把預計要做的事情寫下來，也算是給自己一個動力完成吧！ 把project"><meta name=application-name content="Jimmy's Blog"><meta name=apple-mobile-web-app-title content="Jimmy's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jimmyweng006.github.io/posts/online-judge/><link rel=prev href=https://jimmyweng006.github.io/posts/cmu15-445/><link rel=next href=https://jimmyweng006.github.io/posts/online-judge-go/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Online-Judge","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jimmyweng006.github.io\/posts\/online-judge\/"},"genre":"posts","keywords":"online-judge","wordcount":2100,"url":"https:\/\/jimmyweng006.github.io\/posts\/online-judge\/","datePublished":"2022-06-25T18:41:08+08:00","dateModified":"2022-06-25T18:41:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Jimmy_kiet"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Jimmy's Blog">Jimmy's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>posts </a><a class=menu-item href=/tags/>tags </a><a class=menu-item href=/categories/>categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Jimmy's Blog">Jimmy's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>posts</a><a class=menu-item href=/tags/ title>tags</a><a class=menu-item href=/categories/ title>categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Online-Judge</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Jimmy_kiet</a></span>&nbsp;<span class=post-category>included in <a href=/categories/side-project/><i class="far fa-folder fa-fw" aria-hidden=true></i>side-project</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-06-25>2022-06-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2100 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#day-3>Day 3</a></li><li><a href=#day-4>Day 4</a></li><li><a href=#day-5>Day 5</a></li><li><a href=#day-6>Day 6</a></li><li><a href=#day-7>Day 7</a></li><li><a href=#day-8>Day 8</a></li><li><a href=#day-9>Day 9</a></li><li><a href=#day-10>Day 10</a></li><li><a href=#day-11>Day 11</a></li><li><a href=#day-12>Day 12</a></li><li><a href=#day-13>Day 13</a></li><li><a href=#day-14>Day 14</a></li><li><a href=#day-15>Day 15</a></li><li><a href=#day-16>Day 16</a></li><li><a href=#day-17>Day 17</a></li><li><a href=#day-18>Day 18</a></li></ul></nav></div></div><div class=content id=content><h1 id=online-judge-projecthttpsithelpithomecomtwarticles10233368><a href=https://ithelp.ithome.com.tw/articles/10233368 target=_blank rel="noopener noreffer">Online-Judge-Project</a></h1><h2 id=前言>前言</h2><p>紀錄一下學習強者的project過程，目前完成了前端以外的部分。
先把預計要做的事情寫下來，也算是給自己一個動力完成吧！</p><ol><li>把project的語言從kotlin轉成go</li><li>deploy到AWS-ec2上面</li><li>做個壓力測試跟監控</li></ol><p>雖然整體架構跟API、資料庫都已經開好了，但技術選型(go framework, orm)可能還是要斟酌一下，加油吧！</p><h2 id=day-3>Day 3</h2><ul><li>routing: route requests by two thing<ol><li>Method</li><li>URI(Uniform Resource Identifier)<ul><li>URI 可以：</li></ul><ol><li>單獨表示 URL(locator), subset of URI</li><li>單獨表示 URN(name), subset of URI</li><li>兩者兼具 (identified by locator and name)</li></ol></li><li>request format: [Method] [URI] HTTP/1.1</li><li>response format: HTTP/1.1 [HTTP Status Code] [該 HTTP Status Code 的英文名稱]</li><li>header(parameters) + body(parameters value)</li></ol></li></ul><h2 id=day-4>Day 4</h2><ul><li>data schema</li><li>ktor-jackson: convert data structure to JSON format</li><li>Gradle: 處理專案建置的輔助工具</li></ul><h2 id=day-5>Day 5</h2><ul><li>RESTful API: 題目資源被 /problems 來代表</li></ul><h2 id=day-6>Day 6</h2><ul><li>Http Request:<ol><li>Accept: which format client receive</li><li>Content-Type: which format client send(body)</li></ol></li></ul><h2 id=day-7>Day 7</h2><ul><li>Error Handling:<ol><li>no correspoding route to handle request -> 404 Not Found</li><li>Exception -> 500 Internal Server Error</li><li>create problem with invalid body -> 400 Bad Request</li></ol></li></ul><h2 id=day-8>Day 8</h2><p>password: 秘密
port: 5432</p><ul><li>auto increment title id(SERIAL), date persistency -> database</li><li>Database normalization: Testcases Table use problemId as foreign key</li></ul><h2 id=day-9>Day 9</h2><ul><li>object 這個關鍵字是用在如果你要定義的 class 只會生出一個物件的話，你可以直接用 object 簡寫即可，最後宣告出來的結果會類似於其他語言中的 static class 的使用方式，可以直接將該類別當成一個物件來使用。</li><li>DTO(Data Transfer Object):</li><li>PUT /problems/{id}:<ul><li>testcases in body: {A, B, C}, testcases in database: {A, B, D}</li></ul><ol><li>testcase exist{A, B} -> override it</li><li>testcase not exist{C} -> create it</li><li>testcase disapper{D} -> delete it</li></ol></li><li>DELETE /problems/{id}: A &lt;- B, B depend on A, if you want to delete A, delete B first</li></ul><pre tabindex=0><code>TestCases Table裡的val problem
應該要改成val problemId
才能跟POST /problems裡的變數名稱對起來？
</code></pre><h2 id=day-10>Day 10</h2><pre tabindex=0><code>fun verifyPassword(password: String, passwordHash: String) =
        BCrypt.verifyer().verify(
            password.toCharArray(),
            passwordHash
        ).verified
</code></pre><p>少了最後面的.verified</p><ul><li>驗證機制:<ol><li>Session-Based Authentication: store Session on browser, and put Session Id on cookie(http request header) to authenticate when doing http request</li><li>Token-Based Authentication: similar to Session-Based Authentication, but server doesn&rsquo;t need to store Session</li></ol><ul><li>number of users can be served: Session-Based loss(server need space to store session)</li><li>frequency of users to re-login: Token-Based loss(token need to expire quickly to prevent from stealing)</li></ul></li><li>會員系統:<ul><li>UserIdAuthorityPrincipal: use userId and authority as session</li><li>設定 Session 的值為 userId 和 authority 形成的 UserIdAuthorityPrincipal 物件值，同時設定完也會讓 HTTP response 加上一段告訴客戶端之後要帶什麼樣的 Cookie 值回來。</li><li>after doing logout, cookie on client will also be cleared</li></ul></li></ul><h2 id=day-11>Day 11</h2><ul><li>Submission API</li><li>Authority(change problem operations, submit operation)</li></ul><h2 id=day-12>Day 12</h2><ul><li>Execution of Program<ol><li>透過編譯器將程式碼變成執行檔後，在該編譯出的執行擋可執行之平台執行</li><li>透過編譯器變成中間碼檔案，此中間碼檔案可利用各平台能夠執行該中間碼的程式進行執行。</li><li>直接用直譯器去執行程式碼。</li></ol></li><li>Build environment for Kotlin code to be compiled and executed</li></ul><h2 id=day-13>Day 13</h2><ul><li>Runner proceed submissions process:</li><li>Architecture:</li></ul><pre tabindex=0><code>hierarchy:
        Application.kt(submissionSource, Judger)
        /                                       \
    ISubmissionSource                        Judger
1. ISubmissionSource(FileSubmissionSource, DatabaseSubmissionSource)
    1-1. functions: getNextSubmission(), setSubmissionResult()
2. Judger:
    2-1. components: ICompiler(KotlinCompiler), IExecutor(JVMExecutor)
</code></pre><h2 id=day-14>Day 14</h2><ul><li>connect with postgreSQL, same as Day9</li><li>implement &ldquo;DatabaseSubmissionSource&rdquo; class</li><li>Runner will take unexecuted submission, judge it and then set result</li></ul><h2 id=day-15>Day 15</h2><ul><li>result of runner compile and execute:<ul><li>Accepted (AC)：程式通過審核。</li><li>Wrong Answer (WA)：程式輸出的結果有誤。</li><li>Compile Error (CE)：程式在編譯的時候出現編譯錯誤。</li><li>Runtime Error (RE)：程式在執行時壞掉。</li><li>Time Limit Exceeded (TLE)：程式執行時間超過規定。</li></ul></li></ul><h2 id=day-16>Day 16</h2><ul><li>容器就是基於原本的作業系統，想辦法在主作業系統上，分配部分的資源去建立起一個與外部隔離的環境。</li><li>Docker<ul><li>Image: 環境設定檔</li><li>Container: Image的實體</li><li>Repository: 放Image的地方</li></ul></li><li>goal: 為了要讓容器裡面的環境能夠讀取到我們的程式碼，我們會需要讓主體作業系統分享一個資料夾位置給容器，讓容器可以透過自己的檔案系統讀取到分享的資料夾內的內容。</li><li>compile:</li></ul><pre tabindex=0><code>docker run --rm -v ${System.getProperty(&#34;user.dir&#34;).appendPath(workspace)}:/$workspace 
zenika/kotlin kotlinc /$codeFilePath -include-runtime -d /$executableFilePath

docker run [映像檔名稱] [指令] -&gt; 建立並進入container後執行指令
--rm -&gt; container執行完後自動刪除container
-v [主系統目錄位置]:[Docker 內容器檔案系統目錄位置] -&gt; 兩個位址的內容同步
compileProcess.redirectError(ProcessBuilder.Redirect.INHERIT) -&gt; 執行指令時產生的錯誤會導到runner的console上
</code></pre><ul><li>execute:</li></ul><pre tabindex=0><code>docker run --rm --name DOCKER_CONTAINER_NAME -v ${System.getProperty(&#34;user.dir&#34;).appendPath(workspace)}:/$workspace 
zenika/kotlin sh -c &#39;java -jar /$executableFilename &lt; /$inputFilePath &gt; /$outputFilePath&#39;

java -jar [執行檔於 Docker 容器內的路徑] &lt; [輸入檔於 Docker 容器內的路徑] &gt; [輸出檔於 Docker 容器內的路徑]
sh -c -&gt; 我們想要導向的是 Docker 容器內執行的指令，而非執行 Docker 的指令
--name DOCKER_CONTAINER_NAME -&gt; 當執行executableFilename產生TLE時，
就需要先kill該container(DOCKER_CONTAINER_NAME)，才能把執行這個command的Process(executeProcess) destroy。
</code></pre><ol><li>先是架構不對 amd64 -> arm64</li><li>image跟host同一個架構後(arm64) -> Unable to find image &lsquo;dyninka/kotlin:latest&rsquo; locally, 一直想用最新版的image卻不用現有的image？</li><li>改成用image id取代image名稱&amp;tag -> docker: Error response from daemon: OCI runtime create failed: container_linux.go:380: starting container process caused: exec: &ldquo;kotlinc&rdquo;: executable file not found in $PATH: unknown. ???</li></ol><h2 id=day-17>Day 17</h2><ul><li>-p -> 這裡是將主機的 6379 號碼的 port 與 Docker 容器內的 6379 號碼的 port 連結在了一起，這樣我們才能在 Docker 容器外連進去 Docker 容器內的 Redis 資料庫所預設監聽的 6379 號的 port。</li><li>JudgerSubmissionData(for redis)跟SubmissionData結構相同 -> runner可以直接取用redis的資料不用再做轉換</li><li>由於 submissionId 和 testCaseData 這兩個變數是在 transaction 裡面的 Lambda Function 被修改，導致後面使用 if 語句去判斷是否為 null 時，編譯器不知道該 Lambda Function 實際會在什麼時候執行，故無法保證這兩個值是否真的不為 null -> use two other variables to store</li><li>Jedis.rpush([Queue 的名稱], [要丟進 Queue 內的內容]) -> redis裡面可以有很多個task queue，這裡使用code lauguage做為queue的種類。</li><li>推進去的 JudgerSubmissionData 資料要是 JSON 的格式字串 -> writeValueAsString([資料物件])</li><li>readValue炸裂??? None of the following functions can be called with the arguments supplied.</li></ul><pre tabindex=0><code>return jacksonObjectMapper().readValue(data, SubmissionData::class.java)
</code></pre><ul><li>POST /submissions/restart: super user, unjudged submission will be judge</li><li>POST /submissions/{id}/restart: submission belongs to that user, unjudged/judged submission will be judge</li><li>因為剛遞交的程式碼是在 Redis 資料庫斷線的時候遞交的，所以 Redis 資料庫並沒有收到，也就讓審核程式沒辦法拿到那些程式碼資料去進行批改。 -> call submissions/restart api -> 會把postgreSQL未judge的submission丟到redis裡</li></ul><h2 id=day-18>Day 18</h2><ul><li>support multiple languages<ol><li>image for compile & execute</li><li>implement ICompiler & IExecutor for multiple languages</li></ol></li></ul><pre tabindex=0><code>雖然沒有講到c++的作法，不過因為image可以跟c的共用，
所以只要在跟language相關的地方加上c++的東西即可。
</code></pre></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-06-25</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://jimmyweng006.github.io/posts/online-judge/ data-title=Online-Judge data-hashtags=online-judge><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://jimmyweng006.github.io/posts/online-judge/ data-hashtag=online-judge><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://jimmyweng006.github.io/posts/online-judge/ data-title=Online-Judge><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://jimmyweng006.github.io/posts/online-judge/ data-title=Online-Judge><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://jimmyweng006.github.io/posts/online-judge/ data-title=Online-Judge><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/online-judge/>online-judge</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/cmu15-445/ class=prev rel=prev title=CMU15-445><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>CMU15-445</a>
<a href=/posts/online-judge-go/ class=next rel=next title=Online-Judge-Golang>Online-Judge-Golang<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.122.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Jimmy_kiet</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>